{% extends "admin/dashboard/base_admin.html" %}

{% load i18n humanize %}

{% block page_title %}
  {% trans "Analytics Dashboard" %}
{% endblock page_title %}
{% block page_description %}
  {% trans "Detailed analytics and performance metrics" %}
{% endblock page_description %}
{% block admin_content %}
  <!-- Time Range Selector -->
  <div class="mb-6">
    <div class="admin-metric-card">
      <form method="get" class="flex items-center space-x-4">
        <label class="text-sm font-medium text-gray-700 dark:text-slate-300">{% trans "Time Range:" %}</label>
        <select name="range" class="admin-form-select" onchange="this.form.submit()">
          <option value="24h" {% if time_range == '24h' %}selected{% endif %}>{% trans "Last 24 Hours" %}</option>
          <option value="7d" {% if time_range == '7d' %}selected{% endif %}>{% trans "Last 7 Days" %}</option>
          <option value="30d" {% if time_range == '30d' %}selected{% endif %}>{% trans "Last 30 Days" %}</option>
        </select>
      </form>
    </div>
  </div>
  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Article Trends -->
    <div class="admin-chart-container">
      <h3 class="admin-chart-title">{% trans "Article Publication Trends" %}</h3>
      <div class="relative h-64">
        <canvas id="articleTrendsChart"></canvas>
      </div>
    </div>
    <!-- Search Trends -->
    <div class="admin-chart-container">
      <h3 class="admin-chart-title">{% trans "Search Activity" %}</h3>
      <div class="relative h-64">
        <canvas id="searchTrendsChart"></canvas>
      </div>
    </div>
  </div>
  <!-- Popular Searches -->
  <div class="admin-chart-container mb-8">
    <h3 class="admin-chart-title">{% trans "Popular Search Terms" %}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for search in popular_searches|slice:":9" %}
        <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-3 border border-gray-200 dark:border-slate-600">
          <div class="text-sm font-medium text-gray-900 dark:text-white">"{{ search.normalized_query }}"</div>
          <div class="text-xs text-gray-600 dark:text-slate-400">
            {{ search.search_count }} searches, {{ search.avg_results|floatformat:0 }} avg results
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  <!-- Source Performance -->
  <div class="admin-chart-container">
    <h3 class="admin-chart-title">{% trans "Top Performing Sources" %}</h3>
    <div class="overflow-x-auto">
      <table class="admin-table">
        <thead>
          <tr>
            <th>{% trans "Source" %}</th>
            <th>{% trans "Articles" %}</th>
            <th>{% trans "Avg Views" %}</th>
            <th>{% trans "Total Views" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for source in source_performance|slice:":10" %}
            <tr>
              <td>
                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ source.name }}</div>
              </td>
              <td>
                <span class="admin-badge info">{{ source.articles_count|intcomma }}</span>
              </td>
              <td>
                <span class="admin-badge secondary">{{ source.avg_views|floatformat:0|intcomma }}</span>
              </td>
              <td>
                <span class="admin-badge success">{{ source.total_views|intcomma }}</span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock admin_content %}
{% block admin_javascript %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: {
                size: 12,
                family: "'Inter', sans-serif"
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(107, 114, 128, 0.1)'
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            grid: {
              color: 'rgba(107, 114, 128, 0.1)'
            },
            ticks: {
              font: {
                size: 11
              }
            }
          }
        }
      };

      // Article Trends Chart
      const articleTrendsCtx = document.getElementById('articleTrendsChart');
      if (articleTrendsCtx) {
        const articleTrendsData = [{
          %
          for trend in article_trends %
        } {
          date: '{{ trend.date|date:"M j" }}',
          count: {
            {
              trend.count
            }
          }
        } {
          %
          if not forloop.last %
        }, {
          %
          endif %
        } {
          %
          endfor %
        }];

        new Chart(articleTrendsCtx, {
          type: 'line',
          data: {
            labels: articleTrendsData.map(item => item.date),
            datasets: [{
              label: 'Articles Published',
              data: articleTrendsData.map(item => item.count),
              borderColor: '#4994e8',
              backgroundColor: 'rgba(73, 148, 232, 0.1)',
              borderWidth: 2,
              pointBackgroundColor: '#4994e8',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              tension: 0.4
            }]
          },
          options: chartOptions
        });
      }

      // Search Trends Chart
      const searchTrendsCtx = document.getElementById('searchTrendsChart');
      if (searchTrendsCtx) {
        const searchTrendsData = [{
          %
          for trend in search_trends %
        } {
          date: '{{ trend.date|date:"M j" }}',
          count: {
            {
              trend.count
            }
          },
          avgResults: {
            {
              trend.avg_results |
                default: 0
            }
          }
        } {
          %
          if not forloop.last %
        }, {
          %
          endif %
        } {
          %
          endfor %
        }];

        new Chart(searchTrendsCtx, {
          type: 'line',
          data: {
            labels: searchTrendsData.map(item => item.date),
            datasets: [{
              label: 'Searches',
              data: searchTrendsData.map(item => item.count),
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              tension: 0.4
            }]
          },
          options: chartOptions
        });
      }
    });
  </script>
{% endblock admin_javascript %}
